import os
from openpyxl import load_workbook, Workbook
from openpyxl.utils.dataframe import dataframe_to_rows
import pandas as pd

# Path to the folder containing the 45 Excel workbooks
input_folder = "path_to_your_excel_files"  # Update this!
output_file = "TestResults.xlsx"

# Sheet names to extract and order
sheet_order = ['null', 'distinct', 'duplicate', 'extra1', 'extra2']  # replace 'extra1', 'extra2' with actual names if needed

# Create a new workbook for merged results
merged_wb = Workbook()
merged_wb.remove(merged_wb.active)  # Remove default sheet

# Loop through each file in the folder
for file_name in os.listdir(input_folder):
    if file_name.endswith(".xlsx"):
        file_path = os.path.join(input_folder, file_name)
        wb_name = os.path.splitext(file_name)[0]  # e.g., DIM_COA

        print(f"üìÑ Processing: {file_name}")

        try:
            wb = load_workbook(file_path, data_only=True)
        except Exception as e:
            print(f"‚ùå Error opening {file_name}: {e}")
            continue

        # Create a new sheet in the merged workbook
        target_ws = merged_wb.create_sheet(title=wb_name)

        current_row = 1  # Track row position in target sheet

        for sheet_name in sheet_order:
            if sheet_name not in wb.sheetnames:
                print(f"‚ö†Ô∏è Sheet '{sheet_name}' not found in {file_name}")
                continue

            df = pd.read_excel(file_path, sheet_name=sheet_name)

            # Title in column A
            target_ws.cell(row=current_row, column=1, value=sheet_name.capitalize())

            # Data in column B onwards
            for r_idx, row in enumerate(dataframe_to_rows(df, index=False, header=True), start=current_row + 1):
                for c_idx, value in enumerate(row, start=2):  # Start from column B
                    target_ws.cell(row=r_idx, column=c_idx, value=value)

            # Add 5 blank rows between sections
            current_row = r_idx + 6

# Save the combined workbook
merged_wb.save(output_file)
print(f"\n‚úÖ Merged workbook saved as: {output_file}")
